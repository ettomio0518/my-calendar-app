<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>keyリスト</title>
	<meta name="author" content="ettomio">

    <style>
        /* 全体のスタイル設定 */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            position: relative;
            background-color: #e6e6ff;
        }
        .container {
            max-width: 600px;
            margin: 10px auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: #e7e7e7;
        }

        h2 { font-size: 16px; }
        h3 { font-size: 19px; color: #0000ff; }

        /* ボタンの共通スタイル */
        button {
            width: auto;
            flex-shrink: 0;
            font-size: 16px;
            padding: 3px 10px;
            margin: 3px;
            border-radius: 5px;
            background-color: #ccffff;
            color: black;
    		border: 1px solid black;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* 戻るボタン（右上） */
        .top-right-button {
            position: absolute;
            top: 5px;
            right: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        .top-right-button:hover {
            background-color: #0056b3;
        }

		.bottom-button, .top-button {
		    position: fixed;
		    bottom: 20px;
		    left: 50%;
		    transform: translateX(-50%);
		    background: #007bff;
		    color: white;
		    border: none;
		    border-radius: 20px;
		    padding: 10px 20px;
		    font-size: 16px;
		    cursor: pointer;
		    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
		    z-index: 9999;
		    display: none;
		}
		.bottom-button:hover, .top-button:hover {
		    background: #0056b3;
		}
	    
        #keyButton { background-color: #008040; color: white; }
        #keyButton2 { background-color: #800040; color: white; }
        #keyButton3 { background-color: #0080c0; color: white; }
	 
		.key-label { margin-bottom: 5px; }

        #keys {
            display: inline-block;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            width: 300px;
	    }
	    
	    #keys div { margin: 5px 0; }
	    
		#displayText {
		    text-align: left;
		    width: 100%;
		}
		
		.custom-alert {
		    position: fixed;
		    top: 10px;
		    left: 50%;
		    transform: translateX(-50%);
		    background-color: #6868b5;
		    color: white;
		    padding: 10px 20px;
		    border: 1px solid red;
		    border-radius: 5px;
		    font-size: 16px;
		    z-index: 1000;
		}

		.custom-alert2 {
		    position: fixed;
		    top: 10px;
		    left: 50%;
		    transform: translateX(-50%);
		    background-color: #000;
		    color: #fff;
		    padding: 10px 20px;
		    border: 1px solid red;
		    border-radius: 5px;
		    font-size: 16px;
		    z-index: 1000;
		}

        /* トグルボタンのスタイル */
        #toggleButton {
            background-color: #6c6cff;
            color: white;
            padding: 3px 10px;
            box-sizing: border-box;
			margin-bottom: 20px;
        }

        /* 予定リストのスタイル */
        #scheduleList {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        .schedule-item {
            background-color: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }

        .schedule-info {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 10px;
        }

        .date-display {
            font-weight: bold;
            color: #555;
            margin-right: 10px;
            min-width: 40px;
        }

        .schedule-actions {
            display: flex;
            flex-shrink: 0;
        }

        /* 詳細/消去ボタンのスタイル */
        .detail-btn { background-color: #72b8b8; color: white; }
        .delete-btn { background-color: #ed969e; color: white; }

        /* 修正エリアのスタイル */
        #detailArea {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
        }
        
        #detailDate {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        #detailTextarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            resize: vertical;
            font-size: 1em;
        }

        #saveButton {
            background-color: #ffdc71;
            color: #333;
            width: 50%;
            padding: 10px 15px;
        }

        /* 非表示要素 */
        .hidden { display: none; }
        
		.word-label { margin-bottom: 5px; font-size: 14px; }
		.word-input { margin-top: 0; width: 35%; }
	    .input-row { margin-bottom: 10px; }
	    #scheduleDate { width: 130px; }
    </style>
</head>

<body>
    <button class="top-right-button" onclick="location.href='index.html'">戻る</button>

	<div class="container">
	    <h3>データkeyリスト</h3>

	    <p>このファイルは慎重に扱ってください。</p>
	    	
		<button id="keyButton" onclick="displayKeys()">全keyリストを表示</button>
		<h2>ローカルストレージのKey出力</h2>
		
        <button id="closeKeysButton" style="display: none;" onclick="closeKeys()">キーリストを閉じる</button>		
		<div id="keys"></div>
        <button id="closeKeysButtonN" style="display: none;" onclick="closeKeys()">キーリストを閉じる</button>

		<p class="key-label">Keyの詳細:</p>
		<div class="inline-elements">
		    <label for="keyInput">keyを入力:</label>
		    <input type="text" id="keyInput" class="key-input">
		<button onclick="displayText()">表示</button>
		</div>

		<div id="displayText"></div>
		<button id="closeDetailsButton" style="display: none;" onclick="closeDetails()">詳細を閉じる</button>
		<br>
		<button id="deleteButton" style="display: none;" onclick="deleteKeyAndText()">Keyと本文を削除</button>
		<br>
		
		
	    <button id="toggleButton">全予定リストを表示</button>

	    <ul id="scheduleList" class="hidden"></ul>

	    <div id="detailArea" class="hidden">
	        <h3>詳細・修正</h3>
	        <span id="detailDate"></span>
	        <textarea id="detailTextarea"></textarea>
	        <button id="saveButton">修正して保存</button>
	    </div>
	    <br>
    		
    		
	    <button id="keyButton3" onclick="displayStorageUsage()">ローカルストレージの使用量を表示</button>
		<br><br>
		<button id="keyButton2">全keyを消去</button>
				
	</div>

    <button class="top-button" id="topBtn" onclick="scrollToTop()">Top</button>
	<button class="bottom-button" id="bottomBtn" onclick="scrollToBottom()">Bottom</button>
    <div style="height: 30px;"></div>
	
    <!-- <footer>
	© 20251020 ettomio
	</footer>
	<div style="height: 80px;"></div> -->

	<script>
	    // ==========================================================
	    // ★ 予定リスト関連の定数・変数の定義 (他の場所の定義は削除済み)
	    // ==========================================================
	    const PREFIX = 'ScheduledText'; // 予定データのキー接頭辞

	    const toggleButton = document.getElementById('toggleButton');
	    const scheduleList = document.getElementById('scheduleList');
	    const detailArea = document.getElementById('detailArea');
	    const detailDateSpan = document.getElementById('detailDate'); 
	    const detailTextarea = document.getElementById('detailTextarea');
	    const saveButton = document.getElementById('saveButton');
	    const keyButton2 = document.getElementById('keyButton2'); // 全key消去ボタン

	    let currentKey = null; // 現在修正対象のキーを保持

	    // ==========================================================
	    // ★ 共通ユーティリティ (アラート/音声/ストレージ)
	    // ==========================================================

	    const customAlertContainer = document.createElement('div');
	    customAlertContainer.className = 'custom-alert2';
	    customAlertContainer.style.display = 'none';
	    document.body.appendChild(customAlertContainer);

	    function showCustomAlert(message) {
	        const alertContainer = document.createElement('div');
	        alertContainer.className = 'custom-alert';
	        alertContainer.textContent = message;
	        document.body.appendChild(alertContainer);
	        setTimeout(() => { if(document.body.contains(alertContainer)) { document.body.removeChild(alertContainer); } }, 3000);
	    }
	    
	    function showCustomAlert2(message) {
	        customAlertContainer.textContent = message;
	        customAlertContainer.style.display = 'block';
	        setTimeout(() => { customAlertContainer.style.display = 'none'; }, 3000);
	    }

	    function speakText(text) {
	        if ('speechSynthesis' in window) {
	            const utterance = new SpeechSynthesisUtterance(text);
	            utterance.lang = 'ja-JP';
	            window.speechSynthesis.speak(utterance);
	        } else { showCustomAlert("ご使用のブラウザは音声合成をサポートしていません。"); }
	    }
	    function nativeSpeak(text) {
	        // Android環境でなければWeb標準の音声合成を使う
	        if (typeof Android !== 'undefined' && Android.speak) { Android.speak(text); } 
	        else { speakText(text); }
	    }

	    function getLocalStorageUsage() {
	        let total = 0;
	        for (let i = 0; i < localStorage.length; i++) {
	            const key = localStorage.key(i);
	            const value = localStorage.getItem(key);
	            // キーと値の合計サイズ
	            total += (key ? key.length : 0) + (value ? value.length : 0);
	        }
	        return total; // 使用容量（バイト数）
	    }

	    // ==========================================================
	    // ★ キーリスト機能 (displayKeys/closeKeys/displayText/deleteKeyAndText)
	    // ==========================================================
	    
	    function displayKeys() {
	        const keys = Object.keys(localStorage).sort((a, b) => a.localeCompare(b));
	        const keysElement = document.getElementById('keys');
	        keysElement.innerHTML = '';
	        keys.forEach(key => {
	            const div = document.createElement('div');
	            div.textContent = key;
	            keysElement.appendChild(div);
	        });
	        document.getElementById('closeKeysButton').style.display = 'block';
	        document.getElementById('closeKeysButtonN').style.display = 'block';

	        const message = `ローカルストレージのキーの総数は ${keys.length} 個です。`;
	        showCustomAlert(message);
	        nativeSpeak(message);
	        // キーリストを表示した直後もスクロールボタンの表示をチェック
	        showScrollButtonsIfPageLong(); 
	    }

	    function closeKeys() {
	        const keysElement = document.getElementById('keys');
	        keysElement.innerHTML = '';
	        document.getElementById('closeKeysButton').style.display = 'none';
	        document.getElementById('closeKeysButtonN').style.display = 'none';
	         // キーリストを閉じた後もスクロールボタンの表示をチェック
	        showScrollButtonsIfPageLong();
	    }
	    
	    function displayText() {
	        const key = document.getElementById('keyInput').value;
	        const val = localStorage.getItem(key);
	        const time = localStorage.getItem(key + 'Time');
	        const displayTextElement = document.getElementById('displayText');

	        displayTextElement.style.whiteSpace = 'pre-wrap';

	        if (val !== null) {
	            const content = (val === '') ? '(空文字)' : val;
	            displayTextElement.textContent = `内容: ${content}\n時間: ${time || '保存日時なし'}`;
	            document.getElementById('deleteButton').style.display = 'block';
	        } else {
	            displayTextElement.textContent = '指定したキーは存在しません';
	            document.getElementById('deleteButton').style.display = 'none';
	        }

	        document.getElementById('closeDetailsButton').style.display = 'block';
	    }


	    function closeDetails() {
	        const displayTextElement = document.getElementById('displayText');
	        const keyInputElement = document.getElementById('keyInput');

	        displayTextElement.innerHTML = '';
	        keyInputElement.value = '';
	        document.getElementById('closeDetailsButton').style.display = 'none';
	        document.getElementById('deleteButton').style.display = 'none';
	    }

	    function displayStorageUsage() {
	        const usage = getLocalStorageUsage();
	        const usedKB = (usage / 1024).toFixed(2);
	        const maxStorageKB = 5120;
	        const bytesPerSheet = 800;
	        const usedSheets = Math.round((usage / bytesPerSheet));
	        const remainingKB = (maxStorageKB - usedKB).toFixed(2);
	        const remainingSheets = Math.round(((remainingKB * 1024) / bytesPerSheet));
	        const remainingSheetsS = Math.floor(remainingSheets / 10) * 10;

	        const message = (
	            `ローカルストレージの使用量は` +
	            `原稿用紙約　　${usedSheets} 枚分です。` +
	            `あと、理論上は` +
	            `${remainingSheetsS} 枚分程度の空き容量です。`
	        );

	        showCustomAlert(
	            `ローカルストレージの使用量は　　　${usedKB} KB\n` +
	            `原稿用紙約　　${usedSheets} 枚分です。\n` +
	            `あと、　　　　${remainingKB} KB、　　　　${remainingSheets} 枚分程度の空き容量です。`
	        );

	        nativeSpeak(message);
	    }

	    function deleteKeyAndText() {
	        const key = document.getElementById('keyInput').value;
	        if (localStorage.getItem(key) === null) {
	            showCustomAlert('指定したキーは存在しません');
	            return;
	        }

	        localStorage.removeItem(key);
	        localStorage.removeItem(key + 'Time');

	        closeDetails();
	        closeKeys();
	        showCustomAlert('Keyと本文が削除されました');
	        nativeSpeak('Keyと本文が削除されました');
	    }

	    // ==========================================================
	    // ★ 全キー消去機能
	    // ==========================================================
	    keyButton2.addEventListener('click', function() {
	        const confirmation = confirm('本当に全データを削除しますか？');
	        if (confirmation) {
	            localStorage.clear();
	            showCustomAlert2('データは消去されました'); // custom-alert2を使用
	            nativeSpeak('データは消去されました');
	            
	            // リストと詳細も閉じる
	            closeKeys();
	            hideDetailArea();
	        }
	    });


	    // ==========================================================
	    // ★ 予定リスト機能 (ScheduledText...)
	    // ==========================================================

	    function getSortedScheduleKeys() {
	        const keys = Object.keys(localStorage).filter(key => key.startsWith(PREFIX));
	        keys.sort();
	        return keys;
	    }

	    // YYYY/MM/DD形式で返す
	    function getDisplayDate(key) {
	        const datePart = key.substring(PREFIX.length, PREFIX.length + 8);
	        const year = datePart.substring(0, 4); // 年（YYYY）を抽出
	        const month = datePart.substring(4, 6);
	        const day = datePart.substring(6, 8);
	        return `${year}/${month}/${day}`; // YYYY/MM/DD 形式
	    }

	    function hideDetailArea() {
	        detailArea.classList.add('hidden');
	        detailTextarea.value = '';
	        detailDateSpan.textContent = ''; 
	        currentKey = null;
	    }

	    function showDetailArea(key, dateStr, content) {
	        currentKey = key;
	        detailArea.classList.remove('hidden');
	        // dateStrがYYYY/MM/DD形式で渡されるため、表示もその形式になる
	        detailDateSpan.textContent = `${dateStr} の予定`; 
	        detailTextarea.value = content;
	        
	        detailArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
	        detailTextarea.focus();
	    }

	    function toggleList() {
	        if (scheduleList.classList.contains('hidden')) {
	            displayAllSchedules();
	            scheduleList.classList.remove('hidden');
	            toggleButton.textContent = '予定リストを閉じる';
	            showScrollButtonsIfPageLong(); // リスト表示でボタン表示をチェック
	        } else {
	            scheduleList.classList.add('hidden');
	            toggleButton.textContent = '全予定リストを表示';
	            hideDetailArea();
	            hideScrollButtons(); // リスト非表示でボタンを強制非表示
	        }
	    }

	    function displayAllSchedules() {
	        scheduleList.innerHTML = ''; 
	        const keys = getSortedScheduleKeys();

	        if (keys.length === 0) {
	            scheduleList.innerHTML = '<li class="schedule-item">予定はありません。</li>';
	            return;
	        }

	        keys.forEach(key => {
	            // リスト表示用: MM/DD形式
	            const fullDateStr = getDisplayDate(key); // YYYY/MM/DD 形式を取得
	            const monthDayStr = fullDateStr.substring(5); // MM/DDを取得
	            const fullContent = localStorage.getItem(key) || '内容なし';
	            
	            let displayContent = fullContent;
	            
	            // ★修正点: MM/DD形式を使用して内容の先頭の日付（例: "01/02" や "01/02 "）がある場合は削除
	            const datePattern = new RegExp(`^${monthDayStr}\\s*`);
	            if (datePattern.test(fullContent)) {
	                displayContent = fullContent.replace(datePattern, '').trim();
	            }

	            // 表示内容: 20文字で切り詰める
	            const truncatedContent = displayContent.length > 20
	                ? displayContent.substring(0, 20) + '...'
	                : displayContent;

	            const listItem = document.createElement('li');
	            listItem.className = 'schedule-item';
	            listItem.dataset.key = key;

	            listItem.innerHTML = `
	                <div class="schedule-info">
	                    <span class="date-display">${monthDayStr}</span>
	                    ${truncatedContent || ' (内容なし) '} </div>
	                <div class="schedule-actions">
	                    <button class="detail-btn" data-key="${key}" data-content="${fullContent.replace(/"/g, '&quot;')}">詳細</button>
	                    <button class="delete-btn" data-key="${key}">消去</button>
	                </div>
	            `;
	            scheduleList.appendChild(listItem);
	        });
	    }

	    function deleteSchedule(key) {
	        if (confirm(`${getDisplayDate(key)}の予定を本当に消去しますか？`)) {
	            localStorage.removeItem(key);
	            alert('予定を消去しました。');
	            displayAllSchedules();
	            if (currentKey === key) {
	                hideDetailArea();
	            }
	        }
	    }

	    function saveSchedule() {
	        if (!currentKey) return;

	        const contentToSave = detailTextarea.value.trim();

	        if (!contentToSave) {
	            alert('内容が空では保存できません。');
	            return;
	        }

	        localStorage.setItem(currentKey, contentToSave);
	        alert('修正して保存しました。');

	        displayAllSchedules();
	        hideDetailArea();
	    }

	    // --- 予定リスト イベントリスナー ---
	    toggleButton.addEventListener('click', toggleList);

	    scheduleList.addEventListener('click', (event) => {
	        const target = event.target;
	        const key = target.dataset.key;

	        if (target.classList.contains('detail-btn')) {
	            const fullContent = target.dataset.content;
	            
	            // YYYY/MM/DD形式の日付文字列を生成
	            const fullDateStr = getDisplayDate(key); 
	            
	            // showDetailAreaにYYYY/MM/DD形式を渡す
	            showDetailArea(key, fullDateStr, fullContent); 

	        } else if (target.classList.contains('delete-btn')) {
	            deleteSchedule(key);
	        }
	    });

	    saveButton.addEventListener('click', saveSchedule);


	    // ==========================================================
	    // ★ スクロールボタン制御 (Top/Bottom)
	    // ==========================================================

	    function scrollToTop() {
	      window.scrollTo({ top: 0, behavior: 'smooth' });
	    }

	    function scrollToBottom() {
	      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
	    }

	    function hideScrollButtons() {
	        document.getElementById("topBtn").style.display = "none";
	        document.getElementById("bottomBtn").style.display = "none";
	    }

	    function showScrollButtonsIfPageLong() {
	        const topBtn = document.getElementById("topBtn");
	        const bottomBtn = document.getElementById("bottomBtn");
	        
	        // スケジュールリストが表示されていない、かつキーリストも空の場合は強制非表示
	        if (scheduleList.classList.contains('hidden') && document.getElementById('keys').innerHTML === '') {
	             hideScrollButtons();
	             return;
	        }
	        
	        // ページが十分に長いかチェック (コンテンツが短い場合はボタン不要)
	        const scrollThreshold = 300;
	        const isScrollable = document.body.scrollHeight > window.innerHeight + scrollThreshold; 

	        if (!isScrollable) {
	            hideScrollButtons();
	            return;
	        }

	        // ページが長い場合のスクロール位置による制御
	        const scrollY = window.scrollY;
	        const docHeight = document.body.scrollHeight;
	        const viewHeight = window.innerHeight;
	        
	        if (scrollY > scrollThreshold) {
	            // ある程度スクロールした -> Topボタンを表示
	            topBtn.style.display = "block";
	            bottomBtn.style.display = "none";
	        } else if (scrollY < docHeight - viewHeight - scrollThreshold) {
	            // ページ上部にいるが、底部はまだ遠い -> Bottomボタンを表示
	            topBtn.style.display = "none";
	            bottomBtn.style.display = "block";
	        } else {
	            // ページの下部近くにいる
	            topBtn.style.display = "none";
	            bottomBtn.style.display = "none";
	        }
	    }

	    // スクロール時のボタン表示制御
	    window.addEventListener("scroll", showScrollButtonsIfPageLong);
	    
	    // 初期ロード時にもボタン表示をチェック
	    window.addEventListener("load", showScrollButtonsIfPageLong);
	    
	    // 画面サイズ変更時にもチェック (スマホの向き変更など)
	    window.addEventListener("resize", showScrollButtonsIfPageLong);


	    // ==========================================================
	    // ★ 初期化
	    // ==========================================================
	    // 初期化処理はDOMContentLoadedが完了したタイミングで実行される
	    document.addEventListener('DOMContentLoaded', () => {
	        hideDetailArea();
	        showScrollButtonsIfPageLong();
	    });

	</script>
	
    <footer>
	© 20251020 ettomio
	</footer>
	<div style="height: 80px;"></div>
	
</body>
</html>
