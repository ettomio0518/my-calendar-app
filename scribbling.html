<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èµ°ã‚Šæ›¸ã</title>
<style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      background-color: #ffe6ff;
    }

	.app-header {
	  background: #8080ff;
	  color: white;

	  display: flex;
	  align-items: center;        /* â† ç¸¦ä¸­å¤® */
	  justify-content: space-between;

	  padding: 10px 14px;         /* â† ä½™ç™½ã‚’æœ€å°é™ã« */
	}

	.app-header h1 {
  	  /* margin: 0;   */    /* â† ã“ã‚Œè¶…é‡è¦ */
	  margin-left: 30px; /* â† å·¦ã«30pxã®ä½™ç™½ */  
	  font-size: 18px;
	  font-weight: normal;
	}

	  #lockMark {
	    font-size: 16px;
	  }

	  /* ä»Šã¯ä½¿ç”¨ã—ã¦ã„ãªã„ãŒã€å°†æ¥ã®ãŸã‚ã«æ®‹ã—ã¦ãŠã */ 
	  header button {
	    position: absolute;
	    right: 16px;
	    padding: 6px 14px;
	    border-radius: 18px;
	    border: 1px solid #333;
	    background: #e0ffff;
	    cursor: pointer;
	  }

        h3 { 
        	font-size: 17px; 
        	color: #b87272;  
			margin-top: 5px;   /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šå°ã•ã */        	
			margin-bottom: 7px;   /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šå°ã•ã */
        }
          
	  button {
	    margin: 3px;
	    background-color: #ffffff;
	    border: 1px solid #444;
	    border-radius: 5px;
	    font-size: 15px;       /* â† æ˜ç¤º */
	    line-height: 1.2;      /* â† è¶…é‡è¦ */
	  }

	  .save-button {
	    background: #ffecff;
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    white-space: nowrap;
	    line-height: 1.2;
	  }
	  .button2 {
	    background: #ffffff;
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    white-space: nowrap;
	    line-height: 1.2;
	  }
	  .button3 {
	    background: #d5ffd5;
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    white-space: nowrap;
	    line-height: 1.2;
	  }
	.button4 {
	  background-color: #666; /* å°‘ã—æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
	  color: white;
	  opacity: 0.6;
	  border: none;
	  padding: 4px 12px;
	  border-radius: 4px;
	  font-size: 15px;
	}
	.button4:enabled {
	  opacity: 1;
	  cursor: pointer;
	}

	  .copy-button {
	    background: #ffe8e8;
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    white-space: nowrap;
	    line-height: 1.2;
	  }	
	  
	#toggleHistoryBtn {
	  background: #ffffff;
	  min-width: 72px;
	  padding: 4px 12px;
	  font-size: 15px;
	  white-space: nowrap;
	  line-height: 1.2;
	  border: 1px solid #00f;
	  border-radius: 4px;
	  cursor: pointer;
	}
	    	  
	  main {
	    max-width: 720px;
	    margin: 0 auto;
	    background: #cfe8e8;
	    padding: 20px;
	  }
	  .date-row {
	    display: flex;
	    align-items: center;
	    gap: 8px;
	    margin-bottom: 10px;
	  }
	  .date-row input[type="date"] {
	    padding: 4px 6px;
	  }
	  .date-row button {
	    padding: 4px 10px;
	  }
	.date-row button.active-direction {
	  background-color: #007bff;
	  color: white;
	}

	  textarea {
	    width: 100%;
	    height: 250px;
	    box-sizing: border-box;
	    font-size: 1rem;
	    color: #2d2d2d 
	  }
	  
	  .warn {
	    font-size: 15px;
	    color: #ff2f2f; 
	    margin-top: 10px;
	    margin-bottom: 8px;    
	  }

	    footer {
	      text-align: center;
	      padding: 12px;
	      font-size: 15px;	
	      color: #b87272;                
	    }	
	    
    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ 5/6 */
    .top-right-button {
	  position: static;   /* â† flex ã«ä»»ã›ã‚‹ */    
      width: auto; /* ãƒœã‚¿ãƒ³ã®å¹…ã‚’è‡ªå‹•èª¿æ•´ */
	  position: static;           /* â† absolute ã‚’ã‚„ã‚ã‚‹ */
      top: 15px;
      right: 10px;
      background-color: #e1ffff;
      color: #400040;
	  border: 1px solid #ff8000; /* æ ç·šã‚’è¡¨ç¤º */		      
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .top-right-button:hover {
      background-color: #e3e3f0;
    }

	.calc-btn-wrapper {
	  text-align: right;
	  margin-top: 10px;
	}

	.calc-btn {
	    background: #d7ffff;
	    color: #0000ff; 	    
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    cursor: pointer;	    
	  }
	        
	.modal {
	    display: none;
	    position: fixed;
	    z-index: 99999;
	    left: 0;
	    top: 0;
	    width: 100%;
	    height: 100%;
	    background: rgba(0,0,0,0.4);
	}

	.modal-content {
	    background: white;
	    margin: 10% auto;
	    padding: 10px;
	    width: 90%;
	    max-width: 400px;
	    border-radius: 10px;
	}

	.calc-frame {
	    width: 100%;
	    height: calc(100vh - 120px);
	    border: none;
	}

	.close {
	    float: right;
	    font-size: 24px;
	    cursor: pointer;
	}

    /* 2/5 */
    #keyNButton {
        background-color: #c89191;
        color: white;
        min-width: 72px;
        padding: 4px 12px;
        font-size: 15px;
        white-space: nowrap;
        line-height: 1.2;
    } 

	  /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ä¸‹ã«è¿½åŠ  */
	  #todayButton {
	    color: gray;
	    background-color: transparent;
	    border: 1px solid gray;
	    transition: all 0.3s ease;
	  }

	  #todayButton.today-active {
	    background-color: #007bff; /* é’èƒŒæ™¯ */
	    color: white;              /* ç™½æ–‡å­— */
	    border: none;
	  }
    
	.history-entry {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  margin-bottom: 6px;
	  border-bottom: 1px dashed #ccc;
	  padding-bottom: 4px;
	}

	.history-entry span {
	  flex: 1;
	  overflow: hidden;
	  white-space: nowrap;
	  text-overflow: ellipsis;
	  margin-right: 8px;
	}

	.history-entry button {
	  flex-shrink: 0;
	  font-size: 0.8em;
	  padding: 2px 6px;
      background: #ececec;	  
	}

    /* Topãƒœã‚¿ãƒ³ï¼šæœ€åˆã¯éè¡¨ç¤ºã«ã—ã¦ãŠãã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è¡¨ç¤º 5/5 */
    .top-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #007bff;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 9999;
      display: none; /* æœ€åˆã¯éè¡¨ç¤º */
    }
    .top-button:hover {
      background: #0056b3;
    }

	/* 11/4 Top/Bottomãƒœã‚¿ãƒ³ */
	.bottom-button, .top-button {
	    position: fixed;
	    bottom: 20px;
	    left: 50%;
	    transform: translateX(-50%);
	    background: #007bff;
	    color: white;
	    border: none;
	    border-radius: 20px;
	    padding: 10px 20px;
	    font-size: 16px;
	    cursor: pointer;
	    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
	    z-index: 9999;
	    display: none;
	}
	.bottom-button:hover, .top-button:hover {
	    background: #0056b3;
	}  
		    
</style>

	<script>
	function openOCRReader() {
	  if (typeof Android !== "undefined" && Android.openOCRReader) {
	    Android.openOCRReader(); // WebViewå†…ãªã‚‰ã‚¢ãƒ—ãƒªå´ã¸
	  } else {
	    window.open(
	      'https://ettomio0518.github.io/ettomio-ocr-reader/',
	      '_blank'
	    ); // é€šå¸¸ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰ç›´æ¥é–‹ã
	  }
	}
	</script>

	<script>
	function openQRReader() {
	  if (typeof Android !== "undefined" && Android.openQrReader) {
	    Android.openQrReader(); // WebViewå†…ãªã‚‰ã‚¢ãƒ—ãƒªå´ã¸
	  } else {
	    window.open('https://ettomio0518.github.io/ettomio-qr-reader/', '_blank'); // é€šå¸¸ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰ç›´æ¥é–‹ã
	  }
	}
	</script>
		
</head>

<body>

<header class="app-header">
  <h1>âœï¸ èµ°ã‚Šæ›¸ã scribbling <span id="lockMark"></span></h1>
  <button class="top-right-button">æˆ»ã‚‹</button>
</header>

<main>

  <div class="date-row">
    <button onclick="moveDate(-1)">â—</button>
    <button id="todayButton" onclick="setToday()">ä»Šæ—¥</button>
    <button onclick="moveDate(1)">â–·</button>
    <input type="date" id="dateInput">
  </div>

  <button id="hintToggle" onclick="toggleHint()">â“ï¸äºˆå®šå…¥åŠ›ã®ä»•æ–¹</button>
  <div id="hintBox" style="display: none; font-size: 0.9em; color: #974b00; background: #eee; padding: 6px; margin-top: 4px;">
    èµ°ã‚Šæ›¸ãã«ãµã¨äºˆå®šã‚’æ€ã„ã¤ã„ãŸã‚‰ã€ã€Œ13æ™‚ã€œ15æ™‚ ãƒ†ã‚¹ãƒˆã€ã‚„ã€Œ13æ™‚-15æ™‚ ãƒ†ã‚¹ãƒˆã€ã€ã€Œ13æ™‚ã‹ã‚‰15æ™‚ ãƒ†ã‚¹ãƒˆã€ãªã©ã€æ™‚é–“å¸¯ã‚’å«ã‚ã¦æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚<br>
    æŒ‡ã§ãã®éƒ¨åˆ†ã‚’ãªãã‚‹ã¨ã€äºˆå®šã¨ã—ã¦å…¥åŠ›ã§ãã¾ã™ã€‚<br>
    å…¥åŠ›ã•ã‚ŒãŸäºˆå®šã¯ã€ä»Šæ—¥ã®ã‚«ãƒ¼ãƒ‰ã®æ™‚é–“å‰²ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
  </div>

  <textarea id="memo" placeholder="ã‚¢ã‚¤ãƒ‡ã‚¢ãƒ»è²·ã„ç‰©ãƒ¡ãƒ¢ãªã©è‡ªç”±ã«èµ°ã‚Šæ›¸ã"></textarea>
  <div id="memoDisplay" class="memo-display"></div>

  <div class="action-row">
  	<button class="button3" onclick="openQRReader()">QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</button>  
    <button class="button3" onclick="openOCRReader()">ç°¡æ˜“ç‰ˆOCR</button>        
    <button class="save-button" onclick="saveMemo()">ğŸ’¾ ä¿å­˜</button>
    <button class="button2" onclick="deleteMemo()">ç ´æ£„</button>
    <button class="button2" onclick="deleteOldMemos()">7æ—¥ä»¥ä¸Šå‰ã‚’ç ´æ£„</button>
    <button id="button4" class="button4" onclick="handleSelection()" disabled>ğŸ“Œ é¸æŠã‚’äºˆå®šã«è¿½åŠ </button>
  </div>

  <p class="warn">
    é›‘è¨˜ã§ã™ã®ã§é€ä¸€ãƒ‡ãƒ¼ã‚¿ã¯ç ´æ£„ã—ã¦ãã ã•ã„ã€‚å®¹é‡ã‚’åœ§è¿«ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
  </p>

  <div class="action-row">
    <button class="save-button" onclick="protectMemo()">ğŸ”’ ç ´æ£„ä¸å¯</button>
    <button class="button2" onclick="unprotectMemo()">ğŸ”“ è§£é™¤</button>
    <button id="keyNButton">é«˜æ©Ÿèƒ½æ¤œç´¢</button>
    <button class="copy-button" onclick="copyAll()">å…¨é¸æŠã‚³ãƒ”ãƒ¼</button>
  </div>

  <div class="calc-btn-wrapper">
    <button id="calc-btn" class="calc-btn">ğŸ§® é›»å“</button>
  </div>

  <div id="calcModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCalcModal()">&times;</span>
      <iframe src="calculatorapp.html?from=scribbling" class="calc-frame"></iframe>
    </div>
  </div>

	<button id="toggleHistoryBtn" onclick="toggleHistory()">ğŸ“œ å±¥æ­´è¡¨ç¤º</button>

	<div id="historyPanel" class="history-panel" style="display: none;">
	  <h3>ğŸ“œ èµ°ã‚Šæ›¸ãä¸€è¦§</h3>
	  <div id="historyList"></div>
	</div>

</main>

<script>

	function updateTodayButtonStyle() {
	  const todayButton = document.getElementById('todayButton');
	  const dateInput = document.getElementById('dateInput');

	  const now = new Date();
	  const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

	  if (dateInput.value === todayStr) {
	    todayButton.classList.add('today-active');
	  } else {
	    todayButton.classList.remove('today-active');
	  }
	}

  function memoKey(date) {
    return 'scribbling_' + date.replace(/-/g, '');
  }

  function metaKey(date) {
    return 'scribbling_meta_' + date.replace(/-/g, '');
  }

  function isProtected(date) {
    const meta = JSON.parse(localStorage.getItem(metaKey(date)) || '{}');
    return meta.protected === true;
  }

  function updateLockMark() {
    const dateInput = document.getElementById('dateInput');
    const lockMark = document.getElementById('lockMark');
    lockMark.textContent = isProtected(dateInput.value) ? 'ğŸ”’' : '';
  }

  function loadMemo() {
    const dateInput = document.getElementById('dateInput');
    const memo = document.getElementById('memo');
    const key = memoKey(dateInput.value);
    const saved = localStorage.getItem(key);
    memo.value = saved || '';

    const display = document.getElementById('memoDisplay');
    if (display) {
      // display.innerHTML = linkify(memo.value); // ãƒªãƒ³ã‚¯åŒ–ã—ãªã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    }
  }

	function setToday() {
	  const now = new Date();
	  const y = now.getFullYear();
	  const m = String(now.getMonth() + 1).padStart(2, '0');
	  const d = String(now.getDate()).padStart(2, '0');
	  document.getElementById('dateInput').value = `${y}-${m}-${d}`;
	  loadMemo();
	  updateLockMark();
	  updateTodayButtonStyle(); // â† è¿½åŠ 
	}

	function moveDate(diff) {
	  const dateInput = document.getElementById('dateInput');
	  const parts = dateInput.value.split('-');
	  const d = new Date(parts[0], parts[1] - 1, parts[2]);
	  d.setDate(d.getDate() + diff);
	  dateInput.value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
	  loadMemo();
	  updateLockMark();
	  updateTodayButtonStyle();

	  // ãƒœã‚¿ãƒ³ã®å¼·èª¿è¡¨ç¤º
	  const leftBtn = document.querySelector('.date-row button:nth-child(1)');
	  const rightBtn = document.querySelector('.date-row button:nth-child(3)');
	  const targetBtn = diff < 0 ? leftBtn : rightBtn;

	  targetBtn.classList.add('active-direction');
	  setTimeout(() => targetBtn.classList.remove('active-direction'), 200); // 0.2ç§’å¾Œã«æˆ»ã™
	}

  function saveMemo() {
    const dateInput = document.getElementById('dateInput');
    const memo = document.getElementById('memo');
    localStorage.setItem(memoKey(dateInput.value), memo.value);
    alert('ä¿å­˜ã—ã¾ã—ãŸ');
  }

  function deleteMemo() {
    const dateInput = document.getElementById('dateInput');
    if (isProtected(dateInput.value)) {
      alert('ç ´æ£„ä¸å¯ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚');
      return;
    }
    localStorage.removeItem(memoKey(dateInput.value));
    localStorage.removeItem(metaKey(dateInput.value));
    loadMemo();
    alert('ç ´æ£„ã—ã¾ã—ãŸ');
  }

  function deleteOldMemos() {
    const now = new Date();
    let deleted = 0;
    let protectedCount = 0;

    for (let i = localStorage.length - 1; i >= 0; i--) {
      const key = localStorage.key(i);
      if (!key.startsWith('scribbling_') || key.startsWith('scribbling_meta_')) continue;

      const dateStr = key.replace('scribbling_', '');
      const y = dateStr.slice(0, 4);
      const m = dateStr.slice(4, 6);
      const d = dateStr.slice(6, 8);
      const memoDate = new Date(`${y}-${m}-${d}`);
      const diffDays = (now - memoDate) / (1000 * 60 * 60 * 24);

      if (diffDays >= 7) {
        const date = `${y}-${m}-${d}`;
        if (isProtected(date)) {
          protectedCount++;
        } else {
          localStorage.removeItem(key);
          localStorage.removeItem(metaKey(date));
          deleted++;
        }
      }
    }

    loadMemo();
    alert(`${deleted}ä»¶ã®èµ°ã‚Šæ›¸ãã‚’ç ´æ£„ã—ã¾ã—ãŸã€‚\n${protectedCount}ä»¶ã¯ç ´æ£„ã§ãã¾ã›ã‚“ã€‚`);
  }

  function protectMemo() {
    const dateInput = document.getElementById('dateInput');
    localStorage.setItem(metaKey(dateInput.value), JSON.stringify({ protected: true }));
    updateLockMark();
    alert('ç ´æ£„ä¸å¯ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚');
  }

  function unprotectMemo() {
    const dateInput = document.getElementById('dateInput');
    localStorage.removeItem(metaKey(dateInput.value));
    updateLockMark();
    alert('ç ´æ£„ä¸å¯ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
  }

  function copyAll() {
    const text = document.getElementById('memo').value;
    navigator.clipboard.writeText(text).then(() => {
      alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚„å¤–éƒ¨ã‚¢ãƒ—ãƒªã«è²¼ã‚Šä»˜ã‘ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚');
    });
  }

  function toggleHint() {
    const hint = document.getElementById("hintBox");
    const button = document.getElementById("hintToggle");
    const isVisible = hint.style.display === "block";
    hint.style.display = isVisible ? "none" : "block";
    button.textContent = isVisible ? "â“ï¸äºˆå®šå…¥åŠ›ã®ä»•æ–¹" : "âœ• èª¬æ˜ã‚’é–‰ã˜ã‚‹";
  }

  function checkSelection() {
    const textarea = document.getElementById("memo");
    const button4 = document.getElementById("button4");
    const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();

    const sep = '(?:-|âˆ’|â€“|â€”|ã€œ|ï½|ã‹ã‚‰)';
    const time = '(\\d{1,2})(?:[:ï¼š](\\d{1,2})|æ™‚(?:\\s*(\\d{1,2})åˆ†)?)?';
    const re = new RegExp(time + '\\s*' + sep + '\\s*' + time);

    button4.disabled = !(selectedText && re.test(selectedText));
  }

  function handleSelection() {
    const textarea = document.getElementById('memo');
    const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();
    const button4 = document.getElementById("button4");

    if (!selectedText) {
      alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      button4.disabled = true;
      return;
    }

    const sep = '(?:-|âˆ’|â€“|â€”|ã€œ|ï½|ã‹ã‚‰)';
    const time = '(\\d{1,2})(?:[:ï¼š](\\d{1,2})|æ™‚(?:\\s*(\\d{1,2})åˆ†)?)?';
    const re = new RegExp(time + '\\s*' + sep + '\\s*' + time);

    if (!re.test(selectedText)) {
      alert("æ™‚é–“å¸¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      button4.disabled = true;
      return;
    }

    const confirmed = confirm("é¸æŠã—ãŸå†…å®¹ã‚’äºˆå®šã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) {
      trySaveScheduleFromTextarea();
      if (typeof showTodaySchedule === "function") {
        showTodaySchedule();
      }
    }

    button4.disabled = true;
  }

  function trySaveScheduleFromTextarea() {
    const textarea = document.getElementById('memo');
    const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();

    if (!selectedText) {
      alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const sep = '(?:-|âˆ’|â€“|â€”|ã€œ|ï½|ã‹ã‚‰)';
    const time = '(\\d{1,2})(?:[:ï¼š](\\d{1,2})|æ™‚(?:\\s*(\\d{1,2})åˆ†)?)?';
    const re = new RegExp(time + '\\s*' + sep + '\\s*' + time);
    const match = selectedText.match(re);

    if (!match) {
      alert("æ™‚é–“å¸¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return;
    }

    const sh = parseInt(match[1], 10);
    const sm = match[2] ? parseInt(match[2], 10) : (match[3] ? parseInt(match[3], 10) : 0);
    const eh = parseInt(match[4], 10);
    const em = match[5] ? parseInt(match[5], 10) : (match[6] ? parseInt(match[6], 10) : 0);

    let title = selectedText.replace(re, '').trim() || 'ï¼ˆç„¡é¡Œã®äºˆå®šï¼‰';
    title = title.replace(/^(\s*[ã€,]+)/, '');

    const date = document.getElementById('dateInput').value;
    const ymd = date.replace(/-/g, '');
    const mmdd = `${date.slice(5, 7)}/${date.slice(8, 10)}`;
    const rand = Math.floor(Math.random() * 1000);
    const key = `ScheduledText${ymd}_${rand}`;
    const value = `${mmdd} ${sh}æ™‚${sm ? sm + 'åˆ†' : ''}ã‹ã‚‰${eh}æ™‚${em ? em + 'åˆ†' : ''}ã€${title}`;

    localStorage.setItem(key, value);
    alert("äºˆå®šã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ");
  }

	function toggleHistory() {
	  const panel = document.getElementById('historyPanel');
	  const button = document.getElementById('toggleHistoryBtn');

	  const isVisible = panel.style.display === 'block';
	  panel.style.display = isVisible ? 'none' : 'block';
	  button.textContent = isVisible ? 'ğŸ“œ å±¥æ­´è¡¨ç¤º' : 'âœ• å±¥æ­´ã‚’é–‰ã˜ã‚‹';
	}

	function renderHistoryList() {
	  const historyList = document.getElementById('historyList');
	  historyList.innerHTML = '';

	  const entries = [];

	  for (let i = 0; i < localStorage.length; i++) {
	    const key = localStorage.key(i);
	    if (!key.startsWith('scribbling_') || key.startsWith('scribbling_meta_')) continue;

	    const dateStr = key.replace('scribbling_', '');
	    const y = dateStr.slice(0, 4);
	    const m = dateStr.slice(4, 6);
	    const d = dateStr.slice(6, 8);
	    const date = `${y}-${m}-${d}`;
	    const content = localStorage.getItem(key) || '';
	    const preview = content.split('\n')[0].slice(0, 20); // å…ˆé ­è¡Œã®20æ–‡å­—ã¾ã§

	    entries.push({ date, preview });
	  }

	  // æ—¥ä»˜ã§é™é †ã‚½ãƒ¼ãƒˆ
	  entries.sort((a, b) => b.date.localeCompare(a.date));

	  for (const entry of entries) {
	    const div = document.createElement('div');
	    div.className = 'history-entry';

	    const text = document.createElement('span');
	    text.textContent = `${entry.date}ï¼š${entry.preview}`;

	    const btn = document.createElement('button');
	    btn.textContent = 'è¡¨ç¤º';
	    btn.onclick = () => {
	      document.getElementById('dateInput').value = entry.date;
	      loadMemo();
	      updateLockMark();
	      updateTodayButtonStyle();
	      // ğŸ“œ ä¸Šéƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« 
	      window.scrollTo({ top: 0, behavior: 'smooth' });
	    };

	    div.appendChild(text);
	    div.appendChild(btn);
	    historyList.appendChild(div);
	  }
	}

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
	document.addEventListener("DOMContentLoaded", () => {
	  const textarea = document.getElementById("memo");

	  textarea.addEventListener("mouseup", () => setTimeout(checkSelection, 150));
	  textarea.addEventListener("keyup", checkSelection);
	  textarea.addEventListener("touchend", () => setTimeout(checkSelection, 200));
	  textarea.addEventListener("selectionchange", checkSelection);

	  const dateInput = document.getElementById("dateInput");
	  dateInput.addEventListener("change", () => {
	    loadMemo();
	    updateLockMark();
	    updateTodayButtonStyle(); // â† è¿½åŠ 
	  });

	  // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®é·ç§»å…ˆåˆ‡ã‚Šæ›¿ãˆ
	  const params = new URLSearchParams(location.search);
	  const from = params.get("from");
	  const backBtn = document.querySelector(".top-right-button");
	  if (from === "index") {
	    backBtn.onclick = () => location.href = "index.html";
	  } else {
	    backBtn.onclick = () => location.href = "today-card.html";
	  }

	  // é«˜æ©Ÿèƒ½æ¤œç´¢ãƒœã‚¿ãƒ³ã®é·ç§»å…ˆåˆ‡ã‚Šæ›¿ãˆ
	  const keyNButton = document.getElementById("keyNButton");
	  if (from === "today") {
	    keyNButton.onclick = () => location.href = "AdvancedSearch.html?from=scribbling&origin=today";
	  } else {
	    keyNButton.onclick = () => location.href = "AdvancedSearch.html?from=scribbling&origin=index";
	  }

	  // é›»å“ãƒ¢ãƒ¼ãƒ€ãƒ«
	  document.getElementById("calc-btn").onclick = () => {
	    document.getElementById("calcModal").style.display = "block";
	  };
	  window.closeCalcModal = () => {
	    document.getElementById("calcModal").style.display = "none";
	  };

	  // åˆæœŸè¡¨ç¤º
	  setToday();
	  
		// ğŸ”½ ã“ã“ã«è¿½åŠ ï¼ 
		renderHistoryList();
	});

</script>

	    <button class="top-button" id="topBtn" onclick="scrollToTop()">Top</button>
		<button class="bottom-button" id="bottomBtn" onclick="scrollToBottom()">Bottom</button>

  <script>
	    // ==========================================================
	    // â˜… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³åˆ¶å¾¡ (Top/Bottom)
	    // ==========================================================

	    function scrollToTop() {
	      window.scrollTo({ top: 0, behavior: 'smooth' });
	    }

	    function scrollToBottom() {
	      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
	    }

	    function hideScrollButtons() {
	        document.getElementById("topBtn").style.display = "none";
	        document.getElementById("bottomBtn").style.display = "none";
	    }

		// ==========================================================
		// â˜… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³åˆ¶å¾¡ã®ä¿®æ­£ç‰ˆ (Top/Bottom ç‹¬ç«‹åˆ¶å¾¡) 12/02
		// ==========================================================
		function showScrollButtonsIfPageLong() {
		    const topBtn = document.getElementById("topBtn");
		    const bottomBtn = document.getElementById("bottomBtn");
		    
		    const docHeight = document.body.scrollHeight;
		    const viewHeight = window.innerHeight;
		    const scrollY = window.scrollY;
		    
		    const scrollThreshold = 100; // ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã—ãã„å€¤ (px)
		    
		    // ãƒšãƒ¼ã‚¸ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã§ãªã‘ã‚Œã°ä¸¡æ–¹éè¡¨ç¤º
		    if (docHeight <= viewHeight + scrollThreshold) {
		        topBtn.style.display = "none";
		        bottomBtn.style.display = "none";
		        return;
		    }

		    // --- Topãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ ---
		    // 100pxä»¥ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚‰Topãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
		    if (scrollY > scrollThreshold) {
		        topBtn.style.display = "block";
		    } else {
		        topBtn.style.display = "none";
		    }

			// --- Bottomãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ ---
			// 100pxä»¥ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ã‹ã¤ ä¸‹ç«¯ã¾ã§ä½™è£•ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
			if (
			    scrollY > scrollThreshold &&
			    docHeight - viewHeight - scrollY > scrollThreshold
			) {
			    bottomBtn.style.display = "block";
			} else {
			    bottomBtn.style.display = "none";
			}
		}

	    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
	    window.addEventListener("scroll", showScrollButtonsIfPageLong);
	    
	    // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’ãƒã‚§ãƒƒã‚¯
	    window.addEventListener("load", showScrollButtonsIfPageLong);
	    
	    // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«ã‚‚ãƒã‚§ãƒƒã‚¯ (ã‚¹ãƒãƒ›ã®å‘ãå¤‰æ›´ãªã©)
	    window.addEventListener("resize", showScrollButtonsIfPageLong);


	    // ==========================================================
	    // â˜… åˆæœŸåŒ–
	    // ==========================================================
	    // åˆæœŸåŒ–å‡¦ç†ã¯DOMContentLoadedãŒå®Œäº†ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã‚‹
	    document.addEventListener('DOMContentLoaded', () => {
	        showScrollButtonsIfPageLong();
	    });
	    
  </script>
  
  <footer>
  Â© 20260220 ettomio - èˆã„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  </footer>
  <div style="height: 50px;"></div>
  
</body>
</html>
