<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èµ°ã‚Šæ›¸ã</title>
<style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      background-color: #ffe6ff;
    }

	.app-header {
	  background: #8080ff;
	  color: white;

	  display: flex;
	  align-items: center;        /* â† ç¸¦ä¸­å¤® */
	  justify-content: space-between;

	  padding: 10px 14px;         /* â† ä½™ç™½ã‚’æœ€å°é™ã« */
	}

	.app-header h1 {
  	  /* margin: 0;   */    /* â† ã“ã‚Œè¶…é‡è¦ */
	  margin-left: 30px; /* â† å·¦ã«30pxã®ä½™ç™½ */  
	  font-size: 18px;
	  font-weight: normal;
	}

	  #lockMark {
	    font-size: 16px;
	  }

	  /* ä»Šã¯ä½¿ç”¨ã—ã¦ã„ãªã„ãŒã€å°†æ¥ã®ãŸã‚ã«æ®‹ã—ã¦ãŠã */ 
	  header button {
	    position: absolute;
	    right: 16px;
	    padding: 6px 14px;
	    border-radius: 18px;
	    border: 1px solid #333;
	    background: #e0ffff;
	    cursor: pointer;
	  }
  
	  button {
	    margin: 3px;
	    background-color: #ffffff;
	    border: 1px solid #444;
	    border-radius: 5px;
	    font-size: 15px;       /* â† æ˜ç¤º */
	    line-height: 1.2;      /* â† è¶…é‡è¦ */
	  }

	  .save-button {
	    background: #ffecff;
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    white-space: nowrap;
	    line-height: 1.2;
	  }
	  .button2 {
	    background: #ffffff;
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    white-space: nowrap;
	    line-height: 1.2;
	  }
	  .button3 {
	    background: #d5ffd5;
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    white-space: nowrap;
	    line-height: 1.2;
	  }
	  .copy-button {
	    background: #ffe8e8;
	    min-width: 72px;
	    padding: 4px 12px;
	    font-size: 15px;
	    white-space: nowrap;
	    line-height: 1.2;
	  }	  	  
	  main {
	    max-width: 720px;
	    margin: 0 auto;
	    background: #cfe8e8;
	    padding: 20px;
	  }
	  .date-row {
	    display: flex;
	    align-items: center;
	    gap: 8px;
	    margin-bottom: 10px;
	  }
	  .date-row input[type="date"] {
	    padding: 4px 6px;
	  }
	  .date-row button {
	    padding: 4px 10px;
	  }

	  textarea {
	    width: 100%;
	    height: 250px;
	    box-sizing: border-box;
	    font-size: 1rem;
	  }
	  
	  .warn {
	    font-size: 15px;
	    color: red;
	    margin-top: 10px;
	    margin-bottom: 8px;    
	  }
	  
	  footer {
	    text-align: center;
	    padding: 12px;
	  }	 

    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ 5/6 */
    .top-right-button {
	  position: static;   /* â† flex ã«ä»»ã›ã‚‹ */    
      width: auto; /* ãƒœã‚¿ãƒ³ã®å¹…ã‚’è‡ªå‹•èª¿æ•´ */
	  position: static;           /* â† absolute ã‚’ã‚„ã‚ã‚‹ */
      top: 15px;
      right: 10px;
      background-color: #e1ffff;
      color: #400040;
	  border: 1px solid #ff8000; /* æ ç·šã‚’è¡¨ç¤º */		      
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .top-right-button:hover {
      background-color: #e3e3f0;
    }

.calc-btn-wrapper {
  text-align: right;
  margin-top: 10px;
}

.calc-btn {
  background: #a74fff;
  color: white;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
}
	        
.modal {
    display: none;
    position: fixed;
    z-index: 99999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
}

.modal-content {
    background: white;
    margin: 10% auto;
    padding: 10px;
    width: 90%;
    max-width: 400px;
    border-radius: 10px;
}

.calc-frame {
    width: 100%;
    height: calc(100vh - 120px);
    border: none;
}

.close {
    float: right;
    font-size: 24px;
    cursor: pointer;
}

    /* 2/5 */
    #keyNButton {
        background-color: #c89191;
        color: white;
        min-width: 72px;
        padding: 4px 12px;
        font-size: 15px;
        white-space: nowrap;
        line-height: 1.2;
    } 
    
</style>

	<script>
	function openOCRReader() {
	  if (typeof Android !== "undefined" && Android.openOCRReader) {
	    Android.openOCRReader(); // WebViewå†…ãªã‚‰ã‚¢ãƒ—ãƒªå´ã¸
	  } else {
	    window.open(
	      'https://ettomio0518.github.io/ettomio-ocr-reader/',
	      '_blank'
	    ); // é€šå¸¸ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰ç›´æ¥é–‹ã
	  }
	}
	</script>
	
</head>

<body>

<header class="app-header">
  <h1>âœï¸ èµ°ã‚Šæ›¸ã scribbling <span id="lockMark"></span></h1>
  
	<button class="top-right-button"
  onclick="window.location.href='today-card.html'">æˆ»ã‚‹</button>

</header>

<main>

  <div class="date-row">
    <button onclick="moveDate(-1)">â—</button>
    <button onclick="setToday()">ä»Šæ—¥</button>
    <button onclick="moveDate(1)">â–·</button>
    <input type="date" id="dateInput">
  </div>

  <textarea id="memo" placeholder="ã‚¢ã‚¤ãƒ‡ã‚¢ãƒ»è²·ã„ç‰©ãƒ¡ãƒ¢ãªã©è‡ªç”±ã«èµ°ã‚Šæ›¸ã"></textarea>

  <div class="action-row">
	<button class="button3" onclick="openOCRReader()">ç°¡æ˜“ç‰ˆOCR</button>        
    <button class="save-button" onclick="saveMemo()">ğŸ’¾ ä¿å­˜</button>
    <button class="button2" onclick="deleteMemo()">ç ´æ£„</button>
    <button class="button2" onclick="deleteOldMemos()">7æ—¥ä»¥ä¸Šå‰ã‚’ç ´æ£„</button>
  </div>

  <p class="warn">
    é›‘è¨˜ã§ã™ã®ã§é€ä¸€ãƒ‡ãƒ¼ã‚¿ã¯ç ´æ£„ã—ã¦ãã ã•ã„ã€‚å®¹é‡ã‚’åœ§è¿«ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
  </p>

  <div class="action-row">
    <button class="save-button" onclick="protectMemo()">ğŸ”’ ç ´æ£„ä¸å¯</button>
    <button class="button2" onclick="unprotectMemo()">ğŸ”“ è§£é™¤</button>
	<button id="keyNButton" onclick="location.href='AdvancedSearch.html?from=scribbling'">é«˜æ©Ÿèƒ½æ¤œç´¢</button>
	<button class="copy-button" onclick="copyAll()">å…¨é¸æŠã‚³ãƒ”ãƒ¼</button>


  </div>

	<div class="calc-btn-wrapper">
	  <button id="calc-btn" class="calc-btn">ğŸ§® é›»å“</button>
	</div>
  
</main>

<script>
  const dateInput = document.getElementById('dateInput');
  const memo = document.getElementById('memo');
  const lockMark = document.getElementById('lockMark');

  function memoKey(date) {
    return 'scribbling_' + date.replace(/-/g, '');
  }

  function metaKey(date) {
    return 'scribbling_meta_' + date.replace(/-/g, '');
  }

  function isProtected(date) {
    const meta = JSON.parse(
      localStorage.getItem(metaKey(date)) || '{}'
    );
    return meta.protected === true;
  }

  function updateLockMark() {
    lockMark.textContent = isProtected(dateInput.value) ? 'ğŸ”’' : '';
  }

  function loadMemo() {
    memo.value = localStorage.getItem(memoKey(dateInput.value)) || '';
    updateLockMark();
  }

  function saveMemo() {
    localStorage.setItem(memoKey(dateInput.value), memo.value);
    alert('ä¿å­˜ã—ã¾ã—ãŸ');
  }

	function copyAll() {
	  const text = document.getElementById('memo').value; // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®IDãŒ memo ã®å ´åˆ
	  navigator.clipboard.writeText(text).then(() => {
	    alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚„å¤–éƒ¨ã‚¢ãƒ—ãƒªã«è²¼ã‚Šä»˜ã‘ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚');
	  });
	}

  function protectMemo() {
    localStorage.setItem(
      metaKey(dateInput.value),
      JSON.stringify({ protected: true })
    );
    updateLockMark();
    alert('ç ´æ£„ä¸å¯ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚');
  }

  function unprotectMemo() {
    localStorage.removeItem(metaKey(dateInput.value));
    updateLockMark();
    alert('ç ´æ£„ä¸å¯ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
  }

function deleteMemo() {
  if (isProtected(dateInput.value)) {
    alert('ç ´æ£„ä¸å¯ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚');
    return;
  }

  localStorage.removeItem(memoKey(dateInput.value));
  localStorage.removeItem(metaKey(dateInput.value));

  loadMemo();   // â† ã“ã‚ŒãŒæ±ºå®šçš„ã«é‡è¦
  alert('ç ´æ£„ã—ã¾ã—ãŸ');
}


function deleteOldMemos() {
  const now = new Date();
  let deleted = 0;
  let protectedCount = 0;

  for (let i = localStorage.length - 1; i >= 0; i--) {
    const key = localStorage.key(i);

    if (!key.startsWith('scribbling_') || key.startsWith('scribbling_meta_')) {
      continue;
    }

    const dateStr = key.replace('scribbling_', '');
    const y = dateStr.slice(0, 4);
    const m = dateStr.slice(4, 6);
    const d = dateStr.slice(6, 8);

    const memoDate = new Date(`${y}-${m}-${d}`);
    const diffDays = (now - memoDate) / (1000 * 60 * 60 * 24);

    if (diffDays >= 7) {
      const date = `${y}-${m}-${d}`;

      if (isProtected(date)) {
        protectedCount++;
      } else {
        localStorage.removeItem(key);
        localStorage.removeItem(metaKey(date));
        deleted++;
      }
    }
  }

  loadMemo(); // â† â˜… ã“ã‚Œã‚’è¿½åŠ  â˜…

  alert(`${deleted}ä»¶ã®èµ°ã‚Šæ›¸ãã‚’ç ´æ£„ã—ã¾ã—ãŸã€‚${protectedCount}ä»¶ã¯ç ´æ£„ã§ãã¾ã›ã‚“ã€‚`);
}

  function setToday() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    dateInput.value = `${y}-${m}-${d}`;
    loadMemo();
  }

  function moveDate(diff) {
    const parts = dateInput.value.split('-');
    const d = new Date(parts[0], parts[1] - 1, parts[2]);
    d.setDate(d.getDate() + diff);

    dateInput.value =
      d.getFullYear() + '-' +
      String(d.getMonth() + 1).padStart(2, '0') + '-' +
      String(d.getDate()).padStart(2, '0');

    loadMemo();
  }

  dateInput.addEventListener('change', loadMemo);

  // åˆæœŸè¡¨ç¤º
  setToday();
</script>

<footer>
  Â© 20260206 ettomio - èˆã„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
</footer>

<div id="calcModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeCalcModal()">&times;</span>
    <iframe src="calculatorapp.html?from=scribbling" class="calc-frame"></iframe>
  </div>
</div>

<script>
  document.getElementById("calc-btn").onclick = openCalcModal;

  function openCalcModal() {
    document.getElementById("calcModal").style.display = "block";
  }

  function closeCalcModal() {
    document.getElementById("calcModal").style.display = "none";
  }
</script>

<script>
  const params = new URLSearchParams(location.search);
  const from = params.get("from");

  document.addEventListener("DOMContentLoaded", () => {
    const backBtn = document.querySelector(".top-right-button");

    if (from === "index") {
      backBtn.onclick = () => location.href = "index.html";
    } else {
      backBtn.onclick = () => location.href = "today-card.html";
    }
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(location.search);
    const from = params.get("from");

    const btn = document.getElementById("keyNButton");

    if (from === "today") {
        // ä»Šæ—¥ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰æ¥ãŸå ´åˆ
        btn.onclick = () => location.href = "AdvancedSearch.html?from=scribbling&origin=today";
    } else {
        // index ã‹ã‚‰æ¥ãŸå ´åˆ
        btn.onclick = () => location.href = "AdvancedSearch.html?from=scribbling&origin=index";
    }
});
</script>

</body>
</html>
